! Advanced QoS Configuration Template
! Device: {{ device_name }} - {{ device_os.upper() }}
!
{% if device_os.lower() == 'nxos' %}
! === NX-OS QoS Configuration ===
!
! Enable QoS globally
system qos
qos statistics
!
! Class Maps
{% for class in classes %}
class-map type qos match-any {{ class.name }}
  {% for dscp in class.dscp %}
  match dscp {{ dscp }}
  {% endfor %}
!
{% endfor %}

! Policy Maps
policy-map type qos {{ device_name }}-EGRESS-POLICY
  {% for class in classes %}
  class {{ class.name }}
    {% if class.priority %}
    priority level 1
    {% endif %}
    bandwidth percent {{ class.bandwidth_percent }}
    queue-limit {{ class.queue_limit }} packets
    {% if class.name == 'VOICE' %}
    set dscp ef
    {% elif class.name == 'VIDEO' %}
    set dscp af41
    {% elif class.name == 'CRITICAL-DATA' %}
    set dscp af31
    {% endif %}
  {% endfor %}
  class class-default
    bandwidth percent remaining
    queue-limit 64 packets
    random-detect
!
! Input Classification Policy
policy-map type qos {{ device_name }}-INGRESS-POLICY
  class class-default
    set qos-group 0
    police cir 1000000000 bc 200000000 conform transmit exceed drop
!
! Apply QoS policies to interfaces
{% for interface in interfaces %}
{% if interface.qos_enabled is not defined or interface.qos_enabled %}
interface {{ interface.name }}
  service-policy type qos input {{ device_name }}-INGRESS-POLICY
  service-policy type qos output {{ device_name }}-EGRESS-POLICY
{% endif %}
{% endfor %}

{% else %}
! === IOS QoS Configuration ===
!
! Class Maps
{% for class in classes %}
class-map match-any {{ class.name }}
  {% for dscp in class.dscp %}
  match dscp {{ dscp }}
  {% endfor %}
!
{% endfor %}

! Policy Maps
policy-map {{ device_name }}-EGRESS-POLICY
  {% for class in classes %}
  class {{ class.name }}
    {% if class.priority %}
    priority percent {{ class.bandwidth_percent }}
    {% else %}
    bandwidth percent {{ class.bandwidth_percent }}
    {% endif %}
    queue-limit {{ class.queue_limit }} packets
    {% if class.name == 'VOICE' %}
    set dscp ef
    {% elif class.name == 'VIDEO' %}
    set dscp af41
    {% elif class.name == 'CRITICAL-DATA' %}
    set dscp af31
    {% endif %}
    {% if class.name == 'BEST-EFFORT' %}
    random-detect dscp-based
    random-detect dscp 0 10 40 10
    {% endif %}
  {% endfor %}
  class class-default
    fair-queue
    random-detect
!
! Input Classification Policy
policy-map {{ device_name }}-INGRESS-POLICY
  class class-default
    set qos-group 0
    police cir 1000000000 bc 200000000 conform-action transmit exceed-action drop
!
! Apply QoS policies to interfaces
{% for interface in interfaces %}
{% if interface.qos_enabled is not defined or interface.qos_enabled %}
interface {{ interface.name }}
  service-policy input {{ device_name }}-INGRESS-POLICY
  service-policy output {{ device_name }}-EGRESS-POLICY
{% endif %}
{% endfor %}

{% endif %}

! Traffic Shaping Configuration
!
{% for interface in interfaces %}
{% if interface.speed_limit is defined %}
interface {{ interface.name }}
  {% if device_os.lower() == 'nxos' %}
  rate-mode dedicated
  speed {{ interface.speed_limit }}
  {% else %}
  speed {{ interface.speed_limit }}
  {% endif %}
{% endif %}
{% endfor %}

! Advanced QoS Features
!
! DSCP to CoS mapping
{% if device_os.lower() == 'nxos' %}
qos map dscp-cos 0 8 16 24 32 40 48 56 to 0
qos map dscp-cos 10 18 26 34 42 50 58 to 1
qos map dscp-cos 12 20 28 36 44 52 60 to 2
qos map dscp-cos 14 22 30 38 46 54 62 to 3
qos map dscp-cos 1 9 17 25 33 41 49 57 to 1
qos map dscp-cos 3 11 19 27 35 43 51 59 to 3
qos map dscp-cos 5 13 21 29 37 45 53 61 to 5
qos map dscp-cos 7 15 23 31 39 47 55 63 to 7
{% else %}
! DSCP to CoS mapping table
mls qos map dscp-cos 0 8 16 24 32 40 48 56 to 0
mls qos map dscp-cos 10 18 26 34 42 50 58 to 1
mls qos map dscp-cos 12 20 28 36 44 52 60 to 2
mls qos map dscp-cos 14 22 30 38 46 54 62 to 3
mls qos map dscp-cos 1 9 17 25 33 41 49 57 to 1
mls qos map dscp-cos 3 11 19 27 35 43 51 59 to 3
mls qos map dscp-cos 5 13 21 29 37 45 53 61 to 5
mls qos map dscp-cos 7 15 23 31 39 47 55 63 to 7
{% endif %}

! Trust boundaries
{% for interface in interfaces %}
{% if 'trunk' in interface.description|lower or 'uplink' in interface.description|lower %}
interface {{ interface.name }}
  {% if device_os.lower() == 'nxos' %}
  qos trust dscp
  {% else %}
  mls qos trust dscp
  {% endif %}
{% elif 'access' in interface.description|lower or 'host' in interface.description|lower %}
interface {{ interface.name }}
  {% if device_os.lower() == 'nxos' %}
  qos trust cos
  {% else %}
  mls qos trust cos
  {% endif %}
{% endif %}
{% endfor %}

! QoS Monitoring and Statistics
!
{% if device_os.lower() == 'nxos' %}
! Enable QoS statistics collection
qos statistics
{% else %}
! Enable QoS statistics
mls qos
{% endif %}

! AutoQoS for simplified deployment (optional)
{% for interface in interfaces %}
{% if interface.auto_qos is defined and interface.auto_qos %}
interface {{ interface.name }}
  {% if device_os.lower() == 'nxos' %}
  ! Manual QoS configuration preferred in NX-OS
  {% else %}
  auto qos voip {% if 'phone' in interface.description|lower %}cisco-phone{% else %}trust{% endif %}
  {% endif %}
{% endif %}
{% endfor %}

! QoS Show Commands (for reference)
!
! show policy-map interface
! show class-map
! show mls qos interface statistics
! show qos statistics
